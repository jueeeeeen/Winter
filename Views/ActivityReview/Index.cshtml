@{
    ViewData["Title"] = "Activity Review";
    var activity = ViewData["Activity"] as dynamic;
    var reviews = ViewData["Reviews"] as dynamic;
}

@model dynamic

<header>
    <div class="header-container">
        <img src="../../assets/bookmark.svg" alt="bookmark">
        <p>@Model.Title</p>
    </div>

    <div class="banner">
        <div class="select-member">
            <label for="">Select Member</label>
            <select name="" id="reviewedUser" onchange="getUserReviews()">
                @foreach (var participant in Model.Participants)
                {
                    <option value="@participant.User.Username">
                        @participant.User.FirstName @participant.User.LastName
                    </option>
                }
            </select>
        </div>
        <div class="review-count">
            <span id="reviewCountDisplay"></span>
        </div>
    </div>
</header>

<div class="comment-container">
    <div class="comment">
        <div class="comment-header">
            <p>All comment</p>
        </div>
        <div id="reviewList">
            @if (reviews != null)
            {
                @foreach (var review in reviews)
                {
                    <div class="comment-card" data-reviewed-user="@review.Reviewed_user">
                        <div class="user-info">
                            <div class="comment-profile"><img src="../../assets/profile-g.png" alt="" /></div>
                            <div class="comment-details">
                                <span class="comment-owner">@review.User.FirstName @review.User.LastName</span>
                                <span class="comment-date">@review.Time.ToString("dd MMM yyyy HH:mm")</span>
                                <span class="user-comment">@review.Comment</span>
                            </div>
                        </div>

                        <div class="comment-rating">
                            @for (int i = 1; i <= 5; i++)
                            {
                                if (i <= @review.Rating)
                                {
                                    <img src="../../assets/icon _star.svg" alt="star filled" class="star-icon">
                                }
                                else
                                {
                                    <img src="../../assets/icon_star_empty.svg" alt="star empty" class="star-icon">
                                }
                            }
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

<script>
    let allReviews = Array.from(document.querySelectorAll("#reviewList .comment-card"));
    let totalParticipants = @Model.Participants.Count;

    window.onload = function () {
        getUserReviews();
    };

    function getUserReviews() {
        let selectedUser = document.getElementById("reviewedUser").value;
        let reviewList = document.getElementById("reviewList");
        let reviewCountDisplay = document.getElementById("reviewCountDisplay");

        reviewList.innerHTML = "";

        let filtered = allReviews.filter(review => review.dataset.reviewedUser === selectedUser);

        filtered.forEach(review => reviewList.appendChild(review));

        if (filtered.length > 0) {
            filtered.forEach(review => reviewList.appendChild(review));
        } else {
            let noReviewsDiv = document.createElement("div");
            noReviewsDiv.className = "no-reviews";
            let noReviewsText = document.createElement("span");
            noReviewsText.textContent = "No reviews";
            noReviewsDiv.appendChild(noReviewsText);
            reviewList.appendChild(noReviewsDiv);
        }

        reviewCountDisplay.textContent = `${filtered.length}/${totalParticipants - 1} reviewed`;
    }
</script>